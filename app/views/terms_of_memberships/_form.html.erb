<% # First step %>
<div class="step" id="first">
  <div class="control-group"><%= wizard_steps_indicator(1) %></div>
  <div class="control-group">
    <%= f.label :name, t('activerecord.attributes.terms_of_membership.wizard.plan_name'), :class => 'control-label' %>
    <div class="controls">
      <%= f.text_field :name, :class => 'text_field required', :minlength => 3 %>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.plan_name'), 
        :content => t('lorem') } %> 
    </div>
  </div>
  <div class="control-group">
    <%= f.label :api_role, t('activerecord.attributes.terms_of_membership.wizard.external_code'), :class => 'control-label' %>
    <div class="controls">
      <%= f.text_field :api_role, :value => '', :class => 'text_field input-small'%>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.external_code'), 
        :content => t('lorem') } %> 
    </div>
  </div>
  <div class="control-group">
    <%= f.label :description, t('activerecord.attributes.terms_of_membership.wizard.description'), :class => 'control-label' %>
    <div class="controls">
      <%= f.text_area :description, :class => 'text_area', :rows => 5 %>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.description'), 
        :content => t('lorem') } %> 
    </div>
  </div>
</div>

<% # Second step %>
<div class="step" id="second">  
  <div class="control-group"><%= wizard_steps_indicator(2) %></div>
  
  <div class="control-group">
    <%= label_tag 'initial_fee_amount', t('activerecord.attributes.terms_of_membership.wizard.initial_fee_amount'), :class => 'control-label' %>
    <div class="controls">
      $&nbsp;<%= text_field_tag 'initial_fee_amount', nil, :class => 'text_field input-small required', :placeholder => '0.00', :type => 'number' %>
    </div>
  </div>

  <div class="control-group">
    <%= label_tag 'trial_period_amount', t('activerecord.attributes.terms_of_membership.wizard.trial_period'), :class => 'control-label' %>
    <div class="controls">
      $&nbsp;<%= text_field_tag 'trial_period_amount', nil, :class => 'text_field input-small required', :placeholder => '0.00', :type => 'number' %>
      <%= t('activerecord.attributes.terms_of_membership.wizard.lasting') %>
      <%= text_field_tag 'trial_period_lasting', nil, :class => 'text_field input-small required', :placeholder => '0', :type => 'number' %>
      <%= select_for_date_span("trial_period_lasting_time_span") %>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.trial_period'), 
        :content => t('lorem') } %> 
    </div>
  </div>

  <div class="control-group">
    <%= label_tag 'is_payment_expected', t('activerecord.attributes.terms_of_membership.wizard.at_the_end_of_trial'), :class => 'control-label' %>
    <div class="controls">
      <%= radio_button_tag 'is_payment_expected', 'yes', true %>
      <%= t('activerecord.attributes.terms_of_membership.wizard.payment_is_expected') %>&nbsp;
      <%= radio_button_tag 'is_payment_expected', 'no' %>
      <%= t('activerecord.attributes.terms_of_membership.wizard.no_pay_is_expected') %>&nbsp;
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.at_the_end_of_trial'), 
        :content => t('lorem') } %> 
    </div>
  </div>

  <div class="control-group">
    <%= label_tag 'recurring_amount', t('activerecord.attributes.terms_of_membership.wizard.recurring_amount'), :class => 'control-label' %>
    <div class="controls">
      $&nbsp;<%= text_field_tag 'installment_amount', nil, :class => 'text_field input-small required', :placeholder => '0.00', :type => 'number' %>
      <%= t('activerecord.attributes.terms_of_membership.wizard.every') %>
      <%= text_field_tag 'installment_amount_days', nil, :class => 'text_field input-small required', :placeholder => '0', :type => 'number' %>
      <%= select_for_date_span("installment_amount_days_time_span") %>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.recurring_amount'), 
        :content => t('lorem') } %> 
    </div>
  </div>
  <div class="control-group">
    <%= label_tag 'suscription_terms', t('activerecord.attributes.terms_of_membership.wizard.suscription_terms'), :class => 'control-label' %>
    <div class="controls">
      <%= radio_button_tag 'suscription_terms', 'until_cancelled', true %>
      <span id="label_for_until_cancelled"><%= t('activerecord.attributes.terms_of_membership.wizard.bill_until_cancelled') %></span>
      <br /><br />
      <%= radio_button_tag 'suscription_terms', 'stop_cancel_after' %>
      <span id="label_for_stop_billing_after"><%= t('activerecord.attributes.terms_of_membership.wizard.stop_billing_after') %></span>
      <%= text_field_tag 'suscription_terms_stop_billing_after', nil, :class => 'text_field input-small', :placeholder => '0', :type => 'number' %>
      <%= select_for_date_span("suscription_terms_stop_billing_after_time_span") %>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.suscription_terms'), 
        :content => t('lorem') } %> 
    </div>
  </div>
</div>

<% # Third step %>
<div class="step" id="third">
  <div class="control-group"><%= wizard_steps_indicator(3) %></div>
  <div class="control-group">
    <%= label_tag 'if_cannot_bill_member', t('activerecord.attributes.terms_of_membership.wizard.if_cannot_bill_member_then'), :class => 'control-label' %>
    <div class="controls">
      <%= radio_button_tag 'if_cannot_bill_member', 'cancel', true %>&nbsp;
      <%= t('activerecord.attributes.terms_of_membership.wizard.cancel') %>
      <br /><br />
      <%= radio_button_tag 'if_cannot_bill_member', 'suspend' %>&nbsp;
      <%= t('activerecord.attributes.terms_of_membership.wizard.suspend_for') %>
      <%= text_field_tag 'if_cannot_bill_member_suspend_for', nil, :class => 'text_field input-small', :placeholder => '0', :type => 'number' %>
      <%= select_for_date_span("if_cannot_bill_member_suspend_for_time_span") %>
      <br /><br />
      <%= radio_button_tag 'if_cannot_bill_member', 'downgrade_to' %>&nbsp;
      <%= t('activerecord.attributes.terms_of_membership.wizard.downgrade_to') %>
      <%= select_for_toms('downgrade_to_tom') %>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.if_cannot_bill_member_then'), 
        :content => t('lorem') } %> 
    </div>
  </div>
  <div class="control-group">
    <%= label_tag 'upgrade_to_tom', t('activerecord.attributes.terms_of_membership.wizard.upgrade_to'), :class => 'control-label' %>
    <div class="controls">
      <%= select_for_toms('upgrade_to_tom') %>&nbsp;
      <%= t('activerecord.attributes.terms_of_membership.wizard.after') %>      
      <%= text_field_tag 'upgrade_to_tom_days', nil, :class => 'text_field input-small', :placeholder => '0', :type => 'number' %>
      <%= select_for_date_span("upgrade_to_tom_days_time_span") %>
      <%= render :partial => "shared/help", :locals => { 
        :title => t('activerecord.attributes.terms_of_membership.wizard.upgrade_to'), 
        :content => t('lorem') } %> 
    </div>
  </div>
</div>

<div id="" class="form-actions">
  <%= link_to t('.cancel', :default => t("helpers.links.cancel")), terms_of_memberships_path, :class => 'btn', 
    :confirm => "Do you really want to leave this page?\nAll your changes will be lost." %>
  <div style = "float: right;">
    <%= f.submit "clear", :id => 'back', :class => 'btn', :type => "reset" %>
    <%= f.submit nil, :id => 'next', :class => 'btn btn-primary' %>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function() {
    new_tom_functions();
    set_button_next_label($("#tom_wizard_form").formwizard("state").currentStep);
    window.at_the_end_of_trial = "payment";
  });

  $(function() {
    $("#tom_wizard_form").bind("before_step_shown", function(event, data) {
      set_button_next_label(data.currentStep);
    });
  });

  $('#is_payment_expected_yes').click(function() {
    window.at_the_end_of_trial = "payment";
    update_labels();
  });

  $('#is_payment_expected_no').click(function() {
    window.at_the_end_of_trial = "no payment";
    update_labels();
  });

  $('#suscription_terms_until_cancelled').click(function() {
    $('#suscription_terms_stop_billing_after').removeAttr('required');
  });

  $('#suscription_terms_stop_cancel_after').click(function() {
    $('#suscription_terms_stop_billing_after').prop('required', true);
  });

  $('#if_cannot_bill_member_cancel').click(function() {
    $('#if_cannot_bill_member_suspend_for').removeAttr('required');
    $('#downgrade_to_tom').removeAttr('required');
  });

  $('#if_cannot_bill_member_suspend').click(function() {
    $('#if_cannot_bill_member_suspend_for').prop('required', true);
    $('#downgrade_to_tom').removeAttr('required');
  });

  $('#if_cannot_bill_member_downgrade_to').click(function() {
    $('#if_cannot_bill_member_suspend_for').removeAttr('required');
    $('#downgrade_to_tom').prop('required', true);
  });

  function update_labels() {
    var radio1_text = 'NOT_SET';
    var radio2_text = 'NOT_SET';
    if (window.at_the_end_of_trial == 'payment') {
      radio1_text = '<%= t('activerecord.attributes.terms_of_membership.wizard.bill_until_cancelled') %>';
      radio2_text = '<%= t('activerecord.attributes.terms_of_membership.wizard.stop_billing_after') %>';
    }
    else if (window.at_the_end_of_trial == 'no payment') {
      radio1_text = '<%= t('activerecord.attributes.terms_of_membership.wizard.keep_active_until_manually_cancelled') %>';
      radio2_text = '<%= t('activerecord.attributes.terms_of_membership.wizard.cancel_member_after') %>';
    }
    $('#label_for_until_cancelled').html(radio1_text);
    $('#label_for_stop_billing_after').html(radio2_text);
  }

  function set_button_next_label(currentStep) {
    var isSubmitButton = false;
    var buttonText = 'NOT_SET';
    switch(currentStep) {
      case "first":
        buttonText = '<%= t('activerecord.attributes.terms_of_membership.wizard.step_1_button_next') %>';
        break;
      case "second":
        buttonText = '<%= t('activerecord.attributes.terms_of_membership.wizard.step_2_button_next') %>';
        break;
      case "third":
        isSubmitButton = true;
        buttonText = '<%= t('activerecord.attributes.terms_of_membership.wizard.step_3_button_next') %>';
        break;
    }
    if(isSubmitButton) {
      $("#tom_wizard_form").formwizard("option", {textSubmit: buttonText});
    }
    else {
      $("#tom_wizard_form").formwizard("option", {textNext: buttonText});
    }
  }
</script>
