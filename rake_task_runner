#!/bin/sh

# needs to find ruby and rake binaries
export PATH=$PATH:/usr/local/bin

# 15 0 * * * rake_task_runner
LOGFILE="/tmp/cron_rake.log"

echo "PATH variable => `printenv PATH`"

cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake members:cancel  >> $LOGFILE 2>&1
# rake mes:chargeback_report needs testing in production mode, because in test we dont have chargebacks.
cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake mes:chargeback_report  >> $LOGFILE 2>&1
# billing should be executed after cancel jobs finishes
cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake billing:for_today  >> $LOGFILE 2>&1

cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake billing:send_prebill  >> $LOGFILE 2>&1 &
cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake members:send_pillar_emails  >> $LOGFILE 2>&1 &
cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake members:send_happy_birthday  >> $LOGFILE 2>&1 &
cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake members:process_fulfillments  >> $LOGFILE 2>&1 &
cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake members:process_club_cash  >> $LOGFILE 2>&1 &
cd /var/www/backend-sac-platform/current && RAILS_ENV=$1 rake members:update_cc_type  >> $LOGFILE 2>&1 &

# after this script we should do the BK and reports
WAIT_PIDS=`jobs -l | awk '{print $2}'`

wait $WAIT_PIDS

