#!/bin/bash

export RAILS_ENV=$1

# needs to find ruby and rake binaries
if [ "$1" == "production" ]; then
  export PATH=$PATH:/usr/local/rvm/gems/ruby-1.9.3-p194@sac-platform-rails3/bin:/usr/local/rvm/gems/ruby-1.9.3-p194@global/bin:/usr/local/rvm/rubies
/ruby-1.9.3-p194/bin:/usr/local/rvm/bin:/usr/local/sbin:/usr/local/bin
  [[ -s "/usr/local/rvm/scripts/rvm" ]] && . "/usr/local/rvm/scripts/rvm" && rvm use 1.9.3-p194@sac-platform-rails3
else
  export PATH=$PATH:/usr/local/bin
fi

# 15 0 * * * rake_task_runner
LOGFILE="/tmp/cron_rake.log"

echo "`date` env variable => `env`"

cd /var/www/$2/current && rake members:cancel  >> $LOGFILE 2>&1
cd /var/www/$2/current && rake members:process_sync  >> $LOGFILE 2>&1

if [ "$1" == "production" ]; then
  cd /var/www/$2/current && rake mes:chargeback_report  >> $LOGFILE 2>&1 
  cd /var/www/$2/current && rake mes:account_updater_process_answers  >> $LOGFILE 2>&1
  cd /var/www/$2/current && rake mes:account_updater_send_file_to_process  >> $LOGFILE 2>&1 
fi

# nowadys we will run billing once per day 
cd /var/www/$2/current && rake billing:for_today  >> $LOGFILE 2>&1

cd /var/www/$2/current && rake members:process_fulfillments  >> $LOGFILE 2>&1 &
cd /var/www/$2/current && rake members:process_email_sync_error  >> $LOGFILE 2>&1 &

cd /var/www/$2/current && rake mkt_tools:sync_members_to_exact_target  >> $LOGFILE 2>&1
cd /var/www/$2/current && rake mkt_tools:sync_prospects_to_exact_target  >> $LOGFILE 2>&1
cd /var/www/$2/current && rake mkt_tools:sync_members_to_mailchimp  >> $LOGFILE 2>&1
cd /var/www/$2/current && rake mkt_tools:sync_prospects_to_mailchimp  >> $LOGFILE 2>&1

WAIT_PIDS=`jobs -l | awk '{print $2}'`
wait $WAIT_PIDS

# cd /var/www/$2/current && rake members:sync_members_to_pardot  >> $LOGFILE 2>&1 &
cd /var/www/$2/current && rake billing:send_prebill  >> $LOGFILE 2>&1 &
cd /var/www/$2/current && rake members:send_happy_birthday  >> $LOGFILE 2>&1 &
cd /var/www/$2/current && rake products:send_product_list_email  >> $LOGFILE 2>&1 &
cd /var/www/$2/current && rake members:send_pillar_emails  >> $LOGFILE 2>&1 &
# club cash should be processed before billing. Because if we reset club cash and then we bill, new CC should not be resetted
cd /var/www/$2/current && rake members:process_club_cash  >> $LOGFILE 2>&1 &

# after this script we should do the BK and reports
WAIT_PIDS=`jobs -l | awk '{print $2}'`
wait $WAIT_PIDS

# count members for each  club
cd /var/www/$2/current && rake clubs:count_members_in_clubs >> $LOGFILE 2>&1

DATE=`date +"%u"` # 1 monday
if [ "$1" == "production" ]; then
  if [ "$DATE" == "1" ]; then
    cd /var/www/$2/current && rake fulfillments:send_print_magazine_hot_rod_file >> $LOGFILE 2>&1 
    cd /var/www/$2/current && rake members:send_magazine_cancellation_email >> $LOGFILE 2>&1 
    # cd /var/www/$2/current && rake fulfillments:generate_nfla_report >> $LOGFILE 2>&1 
  fi
  ssh deploy@50.116.28.74 -p 30003 '/home/deploy/sac-platform-reporting/current/generate_reporting_database >> /home/deploy/sac-platform-reporting/current/log/nightly.log 2>&1'
fi
