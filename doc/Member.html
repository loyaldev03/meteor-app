<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Member
  
    &mdash; Documentation by YARD 0.8.2.1
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (M)</a> &raquo;
    
    
    <span class="title">Member</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Member
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">ActiveRecord::Base</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActiveRecord::Base</li>
          
            <li class="next">Member</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2"><span class='object_link'><a href="Extensions/UUID.html" title="Extensions::UUID (module)">Extensions::UUID</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">app/models/member.rb</dd>
  
</dl>
<div class="clear"></div>


  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="REMOTE_API_FIELDS_TO_REPORT-constant" class="">REMOTE_API_FIELDS_TO_REPORT =
          <div class="docstring">
  <div class="discussion">
    <p>
TBD diff with Drupal::Member::OBSERVED_FIELDS ? which one should we keep?
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lbracket'>[</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>first_name</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>last_name</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>email</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>address</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>city</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>state</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>zip</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>country</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>phone_number</span><span class='tstring_end'>'</span></span> <span class='rbracket'>]</span></pre></dd>
      
        <dt id="REGEX_FIRST_AND_LAST_NAME-constant" class="">REGEX_FIRST_AND_LAST_NAME =
          <div class="docstring">
  <div class="discussion">
    <p>
Validates that there are no invalid charactes in the name.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[A-Za-z '-.]+$</span><span class='regexp_end'>/</span></span></pre></dd>
      
        <dt id="REGEX_PHONE_NUMBER-constant" class="">REGEX_PHONE_NUMBER =
          <div class="docstring">
  <div class="discussion">
    <p>
Validates numbers with format like: xxx-xxx-xxxx, xxxx-xxxx(xxxx), +xx
xxxx-xxxx(xxxx), xxx xxx xxxx (intxx) or xxx-xxx-xxxx x123. Only numbers.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^(\([+]?([0-9]{1,3})\))?[-. ]?([0-9]{1,3})?[-. ]?([0-9]{2,3})[-. ]?([0-9]{2,4})?[-. ]?([0-9]{4})([-. ]\(?(x|int)?[0-9]?{1,10}\)?)?$</span><span class='regexp_end'>/</span></span></pre></dd>
      
        <dt id="REGEX_EMAIL-constant" class="">REGEX_EMAIL =
          <div class="docstring">
  <div class="discussion">
    <p>
Validates emails with format like: xxxxxx@xxxx.xxx.xx or
xxxxx+xxx@xxxx.xxx.xx
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^([0-9a-zA-Z]([-\.\w]*[+?]?[0-9a-zA-Z])*@([0-9a-zA-Z][-\w]*[0-9a-zA-Z]\.)+[a-zA-Z]{2,9})$</span><span class='regexp_end'>/</span></span></pre></dd>
      
        <dt id="REGEX_ADDRESS-constant" class="">REGEX_ADDRESS =
          <div class="docstring">
  <div class="discussion">
    <p>
Validates that there are no invalid charactes in the address.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[A-Za-z0-9 -',.\s]+$</span><span class='regexp_end'>/</span></span></pre></dd>
      
        <dt id="REGEX_CITY_AND_STATE_AND_COUNTRY-constant" class="">REGEX_CITY_AND_STATE_AND_COUNTRY =
          <div class="docstring">
  <div class="discussion">
    <p>
Validates that there are no invalid charactes in the country.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[A-Za-z0-9 ',.\s]+$</span><span class='regexp_end'>/</span></span></pre></dd>
      
        <dt id="REGEX_ZIP-constant" class="">REGEX_ZIP =
          <div class="docstring">
  <div class="discussion">
    <p>
Only allows zips with the format: xxxxx or xxxxx-xxxx. Only numbers.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[0-9]{5}(-?[0-9]{4})?$</span><span class='regexp_end'>/</span></span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#enroll-class_method" title="enroll (class method)">+ (Object) <strong>enroll</strong>(tom, current_agent, enrollment_amount, member_params, credit_card_params, cc_blank = '0', params_enrollment_info = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#active_credit_card-instance_method" title="#active_credit_card (instance method)">- (Object) <strong>active_credit_card</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the active credit card that the member is using at the moment.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_club_cash-instance_method" title="#add_club_cash (instance method)">- (Object) <strong>add_club_cash</strong>(agent, amount, description = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Adds club cash transaction.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#after_create_sync_remote_domain-instance_method" title="#after_create_sync_remote_domain (instance method)">- (Object) <strong>after_create_sync_remote_domain</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#after_update_sync_remote_domain-instance_method" title="#after_update_sync_remote_domain (instance method)">- (Object) <strong>after_update_sync_remote_domain</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#api_member-instance_method" title="#api_member (instance method)">- (Object) <strong>api_member</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#assign_club_cash%21-instance_method" title="#assign_club_cash! (instance method)">- (Object) <strong>assign_club_cash!</strong>(message = &quot;Adding club cash on new enrollment.&quot;) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Adds club cash when enrolling.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#bill_membership-instance_method" title="#bill_membership (instance method)">- (Object) <strong>bill_membership</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#can_be_approved%3F-instance_method" title="#can_be_approved? (instance method)">- (Boolean) <strong>can_be_approved?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if member is applied.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#can_be_canceled%3F-instance_method" title="#can_be_canceled? (instance method)">- (Boolean) <strong>can_be_canceled?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if members is lapsed.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#can_be_rejected%3F-instance_method" title="#can_be_rejected? (instance method)">- (Boolean) <strong>can_be_rejected?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if member is applied.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#can_bill_membership%3F-instance_method" title="#can_bill_membership? (instance method)">- (Boolean) <strong>can_bill_membership?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if member is active or provisional.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#can_receive_another_fulfillment%3F-instance_method" title="#can_receive_another_fulfillment? (instance method)">- (Boolean) <strong>can_receive_another_fulfillment?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Do we need rules on fulfillment renewal? Add logic here!!!.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#can_recover%3F-instance_method" title="#can_recover? (instance method)">- (Boolean) <strong>can_recover?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if member is lapsed or if it didnt reach the max reactivation
times.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#can_save_the_sale%3F-instance_method" title="#can_save_the_sale? (instance method)">- (Boolean) <strong>can_save_the_sale?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if member is active or provisional.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#change_next_bill_date%21-instance_method" title="#change_next_bill_date! (instance method)">- (Object) <strong>change_next_bill_date!</strong>(next_bill_date) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Changes next bill date.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#enroll-instance_method" title="#enroll (instance method)">- (Object) <strong>enroll</strong>(credit_card, amount, agent = nil, recovery_check = true, cc_blank = 0, params_enrollment_info = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#error_to_s-instance_method" title="#error_to_s (instance method)">- (Object) <strong>error_to_s</strong>(delimiter = &quot;\n&quot;) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#full_address-instance_method" title="#full_address (instance method)">- (Object) <strong>full_address</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns a string with address, city and state concatenated.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#full_name-instance_method" title="#full_name (instance method)">- (Object) <strong>full_name</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns a string with first and last name concatenated.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#increment_reactivations-instance_method" title="#increment_reactivations (instance method)">- (Object) <strong>increment_reactivations</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Increment reactivation times upon recovering a member.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mega_channel-instance_method" title="#mega_channel (instance method)">- (Object) <strong>mega_channel</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns mega_chanel related to member&#8217;s enrollment_info.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mega_channel%3D-instance_method" title="#mega_channel= (instance method)">- (Object) <strong>mega_channel=</strong>(value) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sets mega_chanel related to member&#8217;s enrollment_info.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#nillify_club_cash-instance_method" title="#nillify_club_cash (instance method)">- (Object) <strong>nillify_club_cash</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Resets member club cash in case of a cancelation.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#recover-instance_method" title="#recover (instance method)">- (Object) <strong>recover</strong>(new_tom_id, agent = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Recovers the member.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset_club_cash-instance_method" title="#reset_club_cash (instance method)">- (Object) <strong>reset_club_cash</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Resets member club cash in case the club cash has expired.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#save_the_sale-instance_method" title="#save_the_sale (instance method)">- (Object) <strong>save_the_sale</strong>(new_tom_id, agent = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#schedule_first_membership-instance_method" title="#schedule_first_membership (instance method)">- (Object) <strong>schedule_first_membership</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sends the fulfillment, and it settes bill_date and next_retry_bill_date
according to member&#8217;s terms of membership.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#schedule_first_membership_for_approved_member-instance_method" title="#schedule_first_membership_for_approved_member (instance method)">- (Object) <strong>schedule_first_membership_for_approved_member</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sends the fulfillment, and it settes bill_date and next_retry_bill_date
according to member&#8217;s terms of membership.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_active_email-instance_method" title="#send_active_email (instance method)">- (Object) <strong>send_active_email</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sends the activation mail.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_fulfillment-instance_method" title="#send_fulfillment (instance method)">- (Object) <strong>send_fulfillment</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_pre_bill-instance_method" title="#send_pre_bill (instance method)">- (Object) <strong>send_pre_bill</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_join_date-instance_method" title="#set_join_date (instance method)">- (Object) <strong>set_join_date</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sets join date.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#skip_api_sync%21-instance_method" title="#skip_api_sync! (instance method)">- (Object) <strong>skip_api_sync!</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#synced%3F-instance_method" title="#synced? (instance method)">- (Boolean) <strong>synced?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="enroll-class_method">
  
    + (<tt>Object</tt>) <strong>enroll</strong>(tom, current_agent, enrollment_amount, member_params, credit_card_params, cc_blank = '0', params_enrollment_info = nil) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 319</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_enroll'>enroll</span><span class='lparen'>(</span><span class='id identifier rubyid_tom'>tom</span><span class='comma'>,</span> <span class='id identifier rubyid_current_agent'>current_agent</span><span class='comma'>,</span> <span class='id identifier rubyid_enrollment_amount'>enrollment_amount</span><span class='comma'>,</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='comma'>,</span> <span class='id identifier rubyid_credit_card_params'>credit_card_params</span><span class='comma'>,</span> <span class='id identifier rubyid_cc_blank'>cc_blank</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>0</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_params_enrollment_info'>params_enrollment_info</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_club'>club</span> <span class='op'>=</span> <span class='id identifier rubyid_tom'>tom</span><span class='period'>.</span><span class='id identifier rubyid_club'>club</span>
  <span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='const'>Member</span><span class='period'>.</span><span class='id identifier rubyid_find_by_email_and_club_id'>find_by_email_and_club_id</span><span class='lparen'>(</span><span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:email</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_club'>club</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='comment'># credit card exist?
</span>    <span class='id identifier rubyid_credit_card_params'>credit_card_params</span><span class='lbracket'>[</span><span class='symbol'>:number</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='comment'># HOT FIX on 
</span>    <span class='id identifier rubyid_credit_card'>credit_card</span> <span class='op'>=</span> <span class='const'>CreditCard</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_credit_card_params'>credit_card_params</span>
    <span class='id identifier rubyid_credit_cards'>credit_cards</span> <span class='op'>=</span> <span class='const'>CreditCard</span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:member</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span> <span class='symbol'>:encrypted_number</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_encrypted_number'>encrypted_number</span><span class='comma'>,</span> <span class='symbol'>:members</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:club_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_club'>club</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='rbrace'>}</span> <span class='rparen'>)</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_credit_cards'>credit_cards</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_cc_blank'>cc_blank</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>1</span><span class='tstring_end'>'</span></span>
      <span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='const'>Member</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:first_name</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_last_name'>last_name</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:last_name</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:address</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:state</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_city'>city</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:city</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_country'>country</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:country</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_phone_number'>phone_number</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:phone_number</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_zip'>zip</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:zip</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_email'>email</span> <span class='op'>=</span> <span class='id identifier rubyid_member_params'>member_params</span><span class='lbracket'>[</span><span class='symbol'>:email</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_skip_api_sync!'>skip_api_sync!</span> <span class='kw'>if</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_api_id'>api_id</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> 
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_club'>club</span> <span class='op'>=</span> <span class='id identifier rubyid_club'>club</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_created_by_id'>created_by_id</span> <span class='op'>=</span> <span class='id identifier rubyid_current_agent'>current_agent</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
      <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span> <span class='op'>=</span> <span class='id identifier rubyid_tom'>tom</span>

      <span class='kw'>unless</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_valid?'>valid?</span> <span class='kw'>and</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_valid?'>valid?</span>
        <span class='id identifier rubyid_errors'>errors</span> <span class='op'>=</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_error_to_s'>error_to_s</span> <span class='op'>+</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_error_to_s'>error_to_s</span>
        <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member data is invalid: \n </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_errors'>errors</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_member_data_invalid'>member_data_invalid</span><span class='comma'>,</span> <span class='symbol'>:errors</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span> <span class='rbrace'>}</span>
      <span class='kw'>end</span>
      <span class='comment'># enroll allowed
</span>    <span class='kw'>elsif</span> <span class='kw'>not</span> <span class='id identifier rubyid_credit_cards'>credit_cards</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_cc'>cc</span><span class='op'>|</span> <span class='id identifier rubyid_cc'>cc</span><span class='period'>.</span><span class='id identifier rubyid_blacklisted?'>blacklisted?</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='comment'># credit card is blacklisted
</span>      <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Credit card blacklisted. call support.</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='id identifier rubyid_current_agent'>current_agent</span><span class='comma'>,</span> <span class='id identifier rubyid_tom'>tom</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_credit_cards'>credit_cards</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_member'>member</span><span class='comma'>,</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_operation_types'>operation_types</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_blacklisted'>credit_card_blacklisted</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_blacklisted'>credit_card_blacklisted</span> <span class='rbrace'>}</span>
    <span class='kw'>elsif</span> <span class='kw'>not</span> <span class='lparen'>(</span><span class='id identifier rubyid_cc_blank'>cc_blank</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>1</span><span class='tstring_end'>'</span></span> <span class='kw'>or</span> <span class='id identifier rubyid_credit_card_params'>credit_card_params</span><span class='lbracket'>[</span><span class='symbol'>:number</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Credit card is already in use. call support.</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='id identifier rubyid_current_agent'>current_agent</span><span class='comma'>,</span> <span class='id identifier rubyid_tom'>tom</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_credit_cards'>credit_cards</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_member'>member</span><span class='comma'>,</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_operation_types'>operation_types</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_already_in_use'>credit_card_already_in_use</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_in_use'>credit_card_in_use</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='comment'># TODO: should we update member profile? and Credit card information?
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_blacklisted'>blacklisted</span>
      <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member email is blacklisted.</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='id identifier rubyid_current_agent'>current_agent</span><span class='comma'>,</span> <span class='id identifier rubyid_tom'>tom</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='id identifier rubyid_member'>member</span><span class='comma'>,</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_operation_types'>operation_types</span><span class='period'>.</span><span class='id identifier rubyid_member_email_blacklisted'>member_email_blacklisted</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_member_email_blacklisted'>member_email_blacklisted</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_credit_card'>credit_card</span> <span class='op'>=</span> <span class='const'>CreditCard</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_credit_card_params'>credit_card_params</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_cc_blank'>cc_blank</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>0</span><span class='tstring_end'>'</span></span> <span class='kw'>and</span> <span class='id identifier rubyid_credit_card_params'>credit_card_params</span><span class='lbracket'>[</span><span class='symbol'>:number</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Credit card is blank. Insert number or allow credit card blank.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_blank'>credit_card_blank</span> <span class='rbrace'>}</span>        
  <span class='kw'>end</span>   

  <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span> <span class='op'>=</span> <span class='id identifier rubyid_tom'>tom</span>
  <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_enroll'>enroll</span><span class='lparen'>(</span><span class='id identifier rubyid_credit_card'>credit_card</span><span class='comma'>,</span> <span class='id identifier rubyid_enrollment_amount'>enrollment_amount</span><span class='comma'>,</span> <span class='id identifier rubyid_current_agent'>current_agent</span><span class='comma'>,</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_cc_blank'>cc_blank</span><span class='comma'>,</span> <span class='id identifier rubyid_params_enrollment_info'>params_enrollment_info</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="active_credit_card-instance_method">
  
    - (<tt>Object</tt>) <strong>active_credit_card</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns the active credit card that the member is using at the moment.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


191
192
193</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 191</span>

<span class='kw'>def</span> <span class='id identifier rubyid_active_credit_card'>active_credit_card</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_credit_cards'>credit_cards</span><span class='period'>.</span><span class='id identifier rubyid_find_by_active'>find_by_active</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_club_cash-instance_method">
  
    - (<tt>Object</tt>) <strong>add_club_cash</strong>(agent, amount, description = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Adds club cash transaction.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 504</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_club_cash'>add_club_cash</span><span class='lparen'>(</span><span class='id identifier rubyid_agent'>agent</span><span class='comma'>,</span><span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span><span class='id identifier rubyid_description'>description</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_answer'>answer</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='const'>ClubCashTransaction</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span> 
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_cct'>cct</span> <span class='op'>=</span> <span class='const'>ClubCashTransaction</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='symbol'>:amount</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='symbol'>:description</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_description'>description</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_cct'>cct</span><span class='period'>.</span><span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='kw'>self</span>
      <span class='id identifier rubyid_cct'>cct</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_club_cash_amount'>club_cash_amount</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_club_cash_amount'>club_cash_amount</span> <span class='op'>+</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
      <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Club cash transaction done!. Amount: $</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cct'>cct</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='id identifier rubyid_agent'>agent</span><span class='comma'>,</span> <span class='id identifier rubyid_cct'>cct</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_answer'>answer</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_success'>success</span> <span class='rbrace'>}</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Could not saved club cash transactions: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cct'>cct</span><span class='period'>.</span><span class='id identifier rubyid_error_to_s'>error_to_s</span><span class='rbrace'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_error_to_s'>error_to_s</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>Airbrake</span><span class='period'>.</span><span class='id identifier rubyid_notify'>notify</span><span class='lparen'>(</span><span class='symbol'>:error_class</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Club cash Transaction</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:error_message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_answer'>answer</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_club_cash_transaction_not_successful'>club_cash_transaction_not_successful</span>  <span class='rbrace'>}</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Rollback</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_answer'>answer</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="after_create_sync_remote_domain-instance_method">
  
    - (<tt>Object</tt>) <strong>after_create_sync_remote_domain</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


53
54
55
56
57
58
59
60</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 53</span>

<span class='kw'>def</span> <span class='id identifier rubyid_after_create_sync_remote_domain'>after_create_sync_remote_domain</span>
  <span class='id identifier rubyid_api_member'>api_member</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span> <span class='kw'>unless</span> <span class='ivar'>@skip_api_sync</span> <span class='op'>||</span> <span class='id identifier rubyid_api_member'>api_member</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='comment'># refs #21133
</span>  <span class='comment'># If there is connectivity problems or data errors with drupal. Do not stop enrollment!! 
</span>  <span class='comment'># Because maybe we have already bill this member.
</span>  <span class='const'>Airbrake</span><span class='period'>.</span><span class='id identifier rubyid_notify'>notify</span><span class='lparen'>(</span><span class='symbol'>:error_class</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member:enroll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:error_message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="after_update_sync_remote_domain-instance_method">
  
    - (<tt>Object</tt>) <strong>after_update_sync_remote_domain</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63
64
65</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 61</span>

<span class='kw'>def</span> <span class='id identifier rubyid_after_update_sync_remote_domain'>after_update_sync_remote_domain</span>
  <span class='kw'>unless</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_changed'>changed</span> <span class='op'>&amp;</span> <span class='const'>REMOTE_API_FIELDS_TO_REPORT</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_api_member'>api_member</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span> <span class='kw'>unless</span> <span class='ivar'>@skip_api_sync</span> <span class='op'>||</span> <span class='id identifier rubyid_api_member'>api_member</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="api_member-instance_method">
  
    - (<tt>Object</tt>) <strong>api_member</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


455
456
457
458
459
460
461</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 455</span>

<span class='kw'>def</span> <span class='id identifier rubyid_api_member'>api_member</span>
  <span class='ivar'>@api_member</span> <span class='op'>||=</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='id identifier rubyid_club'>club</span><span class='period'>.</span><span class='id identifier rubyid_api_type'>api_type</span><span class='comma'>,</span> <span class='id identifier rubyid_club'>club</span><span class='period'>.</span><span class='id identifier rubyid_api_username'>api_username</span><span class='comma'>,</span> <span class='id identifier rubyid_club'>club</span><span class='period'>.</span><span class='id identifier rubyid_api_password'>api_password</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:nil?</span><span class='rparen'>)</span>
    <span class='kw'>nil</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_club'>club</span><span class='period'>.</span><span class='id identifier rubyid_api_type'>api_type</span><span class='period'>.</span><span class='id identifier rubyid_constantize'>constantize</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>self</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="assign_club_cash!-instance_method">
  
    - (<tt>Object</tt>) <strong>assign_club_cash!</strong>(message = &quot;Adding club cash on new enrollment.&quot;) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Adds club cash when enrolling. It calls &#8220;add_club_cash&#8221; method
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


496
497
498
499
500
501</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 496</span>

<span class='kw'>def</span> <span class='id identifier rubyid_assign_club_cash!'>assign_club_cash!</span><span class='lparen'>(</span><span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Adding club cash on new enrollment.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_member_group_type_id'>member_group_type_id</span> <span class='op'>?</span> <span class='id identifier rubyid_amount'>amount</span> <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_club_cash_for_members_who_belongs_to_group'>club_cash_for_members_who_belongs_to_group</span> <span class='op'>:</span> <span class='id identifier rubyid_amount'>amount</span><span class='op'>=</span> <span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_club_cash_amount'>club_cash_amount</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_add_club_cash'>add_club_cash</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_club_cash_expire_date'>club_cash_expire_date</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_join_date'>join_date</span> <span class='op'>+</span> <span class='int'>1</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="bill_membership-instance_method">
  
    - (<tt>Object</tt>) <strong>bill_membership</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 264</span>

<span class='kw'>def</span> <span class='id identifier rubyid_bill_membership'>bill_membership</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_can_bill_membership?'>can_bill_membership?</span>
    <span class='id identifier rubyid_amount'>amount</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_installment_amount'>installment_amount</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&gt;</span> <span class='float'>0.0</span>
      <span class='comment'># Grace period
</span>      <span class='comment'># why cero times? Because only 1 time must be Billed.
</span>      <span class='comment'># Before we were using times = 1. Problem is that times = 1, on case logic will allow times values [0,1].
</span>      <span class='comment'># So grace period will be granted twice.
</span>      <span class='comment'>#        limit = 0 
</span>      <span class='comment'>#        days  = campaign.grace_period
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_active_credit_card'>active_credit_card</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_answer'>answer</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_grace_period'>grace_period</span> <span class='op'>&gt;</span> <span class='int'>0</span>
          <span class='lbrace'>{</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_blank_with_grace'>credit_card_blank_with_grace</span><span class='comma'>,</span> 
            <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Credit card is blank. Allowing grace period</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
        <span class='kw'>else</span>
          <span class='lbrace'>{</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_blank_without_grace'>credit_card_blank_without_grace</span><span class='comma'>,</span>
            <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Credit card is blank and grace period is disabled</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_payment_gateway_configuration'>payment_gateway_configuration</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TOM #</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbrace'>}</span><span class='tstring_content'> does not have a gateway configured.</span><span class='tstring_end'>&quot;</span></span>
          <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_operation_types'>operation_types</span><span class='period'>.</span><span class='id identifier rubyid_membership_billing_without_pgc'>membership_billing_without_pgc</span><span class='rparen'>)</span>
          <span class='const'>Airbrake</span><span class='period'>.</span><span class='id identifier rubyid_notify'>notify</span><span class='lparen'>(</span><span class='symbol'>:error_class</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Billing</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:error_message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
          <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_tom_wihtout_gateway_configured'>tom_wihtout_gateway_configured</span><span class='comma'>,</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span> <span class='rbrace'>}</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_acc'>acc</span> <span class='op'>=</span> <span class='const'>CreditCard</span><span class='period'>.</span><span class='id identifier rubyid_recycle_expired_rule'>recycle_expired_rule</span><span class='lparen'>(</span><span class='id identifier rubyid_active_credit_card'>active_credit_card</span><span class='comma'>,</span> <span class='id identifier rubyid_recycled_times'>recycled_times</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_trans'>trans</span> <span class='op'>=</span> <span class='const'>Transaction</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
        <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_transaction_type'>transaction_type</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sale</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_prepare'>prepare</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_acc'>acc</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_payment_gateway_configuration'>payment_gateway_configuration</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_answer'>answer</span> <span class='op'>=</span> <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>
          <span class='comment'># club_cash_expire_date will be nil if we did not set club cash on enrollment because of a PTX.
</span>          <span class='id identifier rubyid_assign_club_cash!'>assign_club_cash!</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_club_cash_expire_date'>club_cash_expire_date</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='id identifier rubyid_set_as_active!'>set_as_active!</span>
          <span class='id identifier rubyid_schedule_renewal'>schedule_renewal</span>
          <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member billed successfully $</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_amount'>amount</span><span class='rbrace'>}</span><span class='tstring_content'> Transaction id: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
          <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_trans'>trans</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_operation_types'>operation_types</span><span class='period'>.</span><span class='id identifier rubyid_membership_billing'>membership_billing</span><span class='rparen'>)</span>
          <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_success'>success</span><span class='comma'>,</span> <span class='symbol'>:member_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='rbrace'>}</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_set_decline_strategy'>set_decline_strategy</span><span class='lparen'>(</span><span class='id identifier rubyid_trans'>trans</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_answer'>answer</span> <span class='comment'># TODO: should we answer set_decline_strategy message too?
</span>        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Called billing method but no amount on TOM is set.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_no_amount'>no_amount</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member is not in a billing status.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_member_status_dont_allow'>member_status_dont_allow</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="can_be_approved?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>can_be_approved?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns true if member is applied.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


208
209
210</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 208</span>

<span class='kw'>def</span> <span class='id identifier rubyid_can_be_approved?'>can_be_approved?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_applied?'>applied?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="can_be_canceled?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>can_be_canceled?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns true if members is lapsed.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


203
204
205</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 203</span>

<span class='kw'>def</span> <span class='id identifier rubyid_can_be_canceled?'>can_be_canceled?</span>
  <span class='op'>!</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lapsed?'>lapsed?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="can_be_rejected?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>can_be_rejected?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns true if member is applied.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


213
214
215</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 213</span>

<span class='kw'>def</span> <span class='id identifier rubyid_can_be_rejected?'>can_be_rejected?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_applied?'>applied?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="can_bill_membership?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>can_bill_membership?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns true if member is active or provisional.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


223
224
225</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 223</span>

<span class='kw'>def</span> <span class='id identifier rubyid_can_bill_membership?'>can_bill_membership?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_active?'>active?</span> <span class='kw'>or</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_provisional?'>provisional?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="can_receive_another_fulfillment?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>can_receive_another_fulfillment?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Do we need rules on fulfillment renewal? Add logic here!!!
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


235
236
237</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 235</span>

<span class='kw'>def</span> <span class='id identifier rubyid_can_receive_another_fulfillment?'>can_receive_another_fulfillment?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_active?'>active?</span> <span class='kw'>or</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_provisional?'>provisional?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="can_recover?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>can_recover?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns true if member is lapsed or if it didnt reach the max reactivation
times.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


228
229
230
231</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 228</span>

<span class='kw'>def</span> <span class='id identifier rubyid_can_recover?'>can_recover?</span>
<span class='comment'># Add logic to recover some one max 3 times in 5 years
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lapsed?'>lapsed?</span> <span class='kw'>and</span> <span class='id identifier rubyid_reactivation_times'>reactivation_times</span> <span class='op'>&lt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_max_reactivations'>max_reactivations</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="can_save_the_sale?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>can_save_the_sale?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns true if member is active or provisional.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


218
219
220</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 218</span>

<span class='kw'>def</span> <span class='id identifier rubyid_can_save_the_sale?'>can_save_the_sale?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_active?'>active?</span> <span class='kw'>or</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_provisional?'>provisional?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="change_next_bill_date!-instance_method">
  
    - (<tt>Object</tt>) <strong>change_next_bill_date!</strong>(next_bill_date) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Changes next bill date.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


179
180
181
182
183</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 179</span>

<span class='kw'>def</span> <span class='id identifier rubyid_change_next_bill_date!'>change_next_bill_date!</span><span class='lparen'>(</span><span class='id identifier rubyid_next_bill_date'>next_bill_date</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_next_retry_bill_date'>next_retry_bill_date</span> <span class='op'>=</span> <span class='id identifier rubyid_next_bill_date'>next_bill_date</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_bill_date'>bill_date</span> <span class='op'>=</span> <span class='id identifier rubyid_next_bill_date'>next_bill_date</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="enroll-instance_method">
  
    - (<tt>Object</tt>) <strong>enroll</strong>(credit_card, amount, agent = nil, recovery_check = true, cc_blank = 0, params_enrollment_info = nil) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 377</span>

<span class='kw'>def</span> <span class='id identifier rubyid_enroll'>enroll</span><span class='lparen'>(</span><span class='id identifier rubyid_credit_card'>credit_card</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='id identifier rubyid_agent'>agent</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_recovery_check'>recovery_check</span> <span class='op'>=</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_cc_blank'>cc_blank</span> <span class='op'>=</span> <span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_params_enrollment_info'>params_enrollment_info</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>==</span> <span class='int'>0</span> <span class='kw'>and</span> <span class='id identifier rubyid_cc_blank'>cc_blank</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>1</span><span class='tstring_end'>'</span></span> <span class='op'>?</span> <span class='id identifier rubyid_allow_cc_blank'>allow_cc_blank</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='op'>:</span> <span class='id identifier rubyid_allow_cc_blank'>allow_cc_blank</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_recovery_check'>recovery_check</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_new_record?'>new_record?</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_can_recover?'>can_recover?</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cant recover member. Actual status is not lapsed or Max reactivations reached.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_cant_recover_member'>cant_recover_member</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='kw'>not</span> <span class='const'>CreditCard</span><span class='period'>.</span><span class='id identifier rubyid_am_card'>am_card</span><span class='lparen'>(</span><span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_number'>number</span><span class='comma'>,</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_expire_month'>expire_month</span><span class='comma'>,</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_expire_year'>expire_year</span><span class='comma'>,</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_valid?'>valid?</span>
      <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Credit card is invalid or is expired!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_invalid_credit_card'>invalid_credit_card</span> <span class='rbrace'>}</span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_allow_cc_blank'>allow_cc_blank</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_blacklisted?'>blacklisted?</span> <span class='kw'>or</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_blacklisted?'>blacklisted?</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member or credit card are blacklisted</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_blacklisted'>blacklisted</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='kw'>not</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_valid?'>valid?</span> 
    <span class='id identifier rubyid_errors'>errors</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_error_to_s'>error_to_s</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member data is invalid: \n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_errors'>errors</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_member_data_invalid'>member_data_invalid</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
      
  <span class='kw'>if</span> <span class='id identifier rubyid_amount'>amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>!=</span> <span class='float'>0.0</span>
    <span class='id identifier rubyid_trans'>trans</span> <span class='op'>=</span> <span class='const'>Transaction</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_transaction_type'>transaction_type</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sale</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_prepare'>prepare</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_payment_gateway_configuration'>payment_gateway_configuration</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_answer'>answer</span> <span class='op'>=</span> <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>
      <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='id identifier rubyid_agent'>agent</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_answer'>answer</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_answer'>answer</span> 
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  
  <span class='kw'>begin</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

    <span class='id identifier rubyid_enrollment_info'>enrollment_info</span> <span class='op'>=</span> <span class='const'>EnrollmentInfo</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_params_enrollment_info'>params_enrollment_info</span>
    <span class='id identifier rubyid_enrollment_info'>enrollment_info</span><span class='period'>.</span><span class='id identifier rubyid_member_id'>member_id</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
    <span class='id identifier rubyid_enrollment_info'>enrollment_info</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership_id'>terms_of_membership_id</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership_id'>terms_of_membership_id</span>
    <span class='id identifier rubyid_enrollment_info'>enrollment_info</span><span class='period'>.</span><span class='id identifier rubyid_enrollment_amount'>enrollment_amount</span> <span class='op'>=</span> <span class='id identifier rubyid_amount'>amount</span>
    <span class='id identifier rubyid_enrollment_info'>enrollment_info</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_member'>member</span> <span class='op'>=</span> <span class='kw'>self</span>
      <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_trans'>trans</span>
      <span class='comment'># We cant assign this information before , because models must be created AFTER transaction
</span>      <span class='comment'># is completed succesfully
</span>      <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_member_id'>member_id</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
      <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_credit_card_id'>credit_card_id</span> <span class='op'>=</span> <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
      <span class='id identifier rubyid_trans'>trans</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_credit_card'>credit_card</span><span class='period'>.</span><span class='id identifier rubyid_accepted_on_billing'>accepted_on_billing</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_set_status_on_enrollment!'>set_status_on_enrollment!</span><span class='lparen'>(</span><span class='id identifier rubyid_agent'>agent</span><span class='comma'>,</span> <span class='id identifier rubyid_trans'>trans</span><span class='comma'>,</span> <span class='id identifier rubyid_amount'>amount</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_assign_club_cash!'>assign_club_cash!</span> <span class='kw'>if</span> <span class='id identifier rubyid_trans'>trans</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
    <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_success'>success</span><span class='comma'>,</span> <span class='symbol'>:member_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbol'>:v_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_visible_id'>visible_id</span><span class='comma'>,</span> <span class='symbol'>:prospect_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_enrollment_info'>enrollment_info</span><span class='period'>.</span><span class='id identifier rubyid_prospect_id'>prospect_id</span> <span class='rbrace'>}</span>
    
  <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='const'>Airbrake</span><span class='period'>.</span><span class='id identifier rubyid_notify'>notify</span><span class='lparen'>(</span><span class='symbol'>:error_class</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member:enroll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:error_message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
    <span class='comment'># TODO: this can happend if in the same time a new member is enrolled that makes this an invalid one. Do we have to revert transaction?
</span>    <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Could not save member. </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='id identifier rubyid_agent'>agent</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_operation_types'>operation_types</span><span class='period'>.</span><span class='id identifier rubyid_enrollment_billing'>enrollment_billing</span><span class='rparen'>)</span>
    <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_member_not_saved'>member_not_saved</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="error_to_s-instance_method">
  
    - (<tt>Object</tt>) <strong>error_to_s</strong>(delimiter = &quot;\n&quot;) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


315
316
317</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 315</span>

<span class='kw'>def</span> <span class='id identifier rubyid_error_to_s'>error_to_s</span><span class='lparen'>(</span><span class='id identifier rubyid_delimiter'>delimiter</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_attr'>attr</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attr'>attr</span><span class='rbrace'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_delimiter'>delimiter</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="full_address-instance_method">
  
    - (<tt>Object</tt>) <strong>full_address</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns a string with address, city and state concatenated.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


196
197
198</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 196</span>

<span class='kw'>def</span> <span class='id identifier rubyid_full_address'>full_address</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_city'>city</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="full_name-instance_method">
  
    - (<tt>Object</tt>) <strong>full_name</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns a string with first and last name concatenated.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


186
187
188</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 186</span>

<span class='kw'>def</span> <span class='id identifier rubyid_full_name'>full_name</span>
  <span class='lbracket'>[</span> <span class='id identifier rubyid_first_name'>first_name</span><span class='comma'>,</span> <span class='id identifier rubyid_last_name'>last_name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_squeeze'>squeeze</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="increment_reactivations-instance_method">
  
    - (<tt>Object</tt>) <strong>increment_reactivations</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Increment reactivation times upon recovering a member. (From lapsed to
provisional or applied)
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


142
143
144</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 142</span>

<span class='kw'>def</span> <span class='id identifier rubyid_increment_reactivations'>increment_reactivations</span>
  <span class='id identifier rubyid_increment!'>increment!</span><span class='lparen'>(</span><span class='symbol'>:reactivation_times</span><span class='comma'>,</span> <span class='int'>1</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="mega_channel-instance_method">
  
    - (<tt>Object</tt>) <strong>mega_channel</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Returns mega_chanel related to member&#8217;s enrollment_info
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


464
465
466</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 464</span>

<span class='kw'>def</span> <span class='id identifier rubyid_mega_channel'>mega_channel</span>
  <span class='const'>EnrollmentInfo</span><span class='period'>.</span><span class='id identifier rubyid_find_by_member_id'>find_by_member_id</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_mega_channel'>mega_channel</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="mega_channel=-instance_method">
  
    - (<tt>Object</tt>) <strong>mega_channel=</strong>(value) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Sets mega_chanel related to member&#8217;s enrollment_info
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


469
470
471
472</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 469</span>

<span class='kw'>def</span> <span class='id identifier rubyid_mega_channel='>mega_channel=</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_enrollment_info'>enrollment_info</span><span class='period'>.</span><span class='id identifier rubyid_mega_channel'>mega_channel</span> <span class='op'>||=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_enrollment_info'>enrollment_info</span><span class='period'>.</span><span class='id identifier rubyid_mega_channel'>mega_channel</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="nillify_club_cash-instance_method">
  
    - (<tt>Object</tt>) <strong>nillify_club_cash</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Resets member club cash in case of a cancelation. It calls
&#8220;add_club_cash&#8221; method
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


485
486
487</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 485</span>

<span class='kw'>def</span> <span class='id identifier rubyid_nillify_club_cash'>nillify_club_cash</span>
  <span class='id identifier rubyid_add_club_cash'>add_club_cash</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>-</span><span class='id identifier rubyid_club_cash_amount'>club_cash_amount</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Removing club cash because of member cancellation</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_club_cash_amount'>club_cash_amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>==</span> <span class='float'>0.0</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="recover-instance_method">
  
    - (<tt>Object</tt>) <strong>recover</strong>(new_tom_id, agent = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Recovers the member. Changes status from lapsed to applied or provisional
(according to members term of membership.)
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


259
260
261
262</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 259</span>

<span class='kw'>def</span> <span class='id identifier rubyid_recover'>recover</span><span class='lparen'>(</span><span class='id identifier rubyid_new_tom_id'>new_tom_id</span><span class='comma'>,</span> <span class='id identifier rubyid_agent'>agent</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership_id'>terms_of_membership_id</span> <span class='op'>=</span> <span class='id identifier rubyid_new_tom_id'>new_tom_id</span>
  <span class='id identifier rubyid_enroll'>enroll</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_active_credit_card'>active_credit_card</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='comma'>,</span> <span class='id identifier rubyid_agent'>agent</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reset_club_cash-instance_method">
  
    - (<tt>Object</tt>) <strong>reset_club_cash</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Resets member club cash in case the club cash has expired. It calls
&#8220;add_club_cash&#8221; method
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


490
491
492
493</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 490</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_club_cash'>reset_club_cash</span>
  <span class='id identifier rubyid_add_club_cash'>add_club_cash</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>-</span><span class='id identifier rubyid_club_cash_amount'>club_cash_amount</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Removing expired club cash.</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_club_cash_amount'>club_cash_amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>==</span> <span class='float'>0.0</span>
  <span class='id identifier rubyid_assign_club_cash!'>assign_club_cash!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Renewing club cash.</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="save_the_sale-instance_method">
  
    - (<tt>Object</tt>) <strong>save_the_sale</strong>(new_tom_id, agent = nil) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 240</span>

<span class='kw'>def</span> <span class='id identifier rubyid_save_the_sale'>save_the_sale</span><span class='lparen'>(</span><span class='id identifier rubyid_new_tom_id'>new_tom_id</span><span class='comma'>,</span> <span class='id identifier rubyid_agent'>agent</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_can_save_the_sale?'>can_save_the_sale?</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_new_tom_id'>new_tom_id</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>==</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership_id'>terms_of_membership_id</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Nothing to change. Member is already enrolled on that TOM.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_nothing_to_change_tom'>nothing_to_change_tom</span> <span class='rbrace'>}</span>
    <span class='kw'>else</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership_id'>terms_of_membership_id</span> <span class='op'>=</span> <span class='id identifier rubyid_new_tom_id'>new_tom_id</span>
      <span class='id identifier rubyid_res'>res</span> <span class='op'>=</span> <span class='id identifier rubyid_enroll'>enroll</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_active_credit_card'>active_credit_card</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='comma'>,</span> <span class='id identifier rubyid_agent'>agent</span><span class='comma'>,</span> <span class='kw'>false</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='symbol'>:code</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_success'>success</span>
        <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Save the sale from TOMID </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_terms_of_membership_id'>terms_of_membership_id</span><span class='rbrace'>}</span><span class='tstring_content'> to TOMID </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_new_tom_id'>new_tom_id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='const'>Auditory</span><span class='period'>.</span><span class='id identifier rubyid_audit'>audit</span><span class='lparen'>(</span><span class='id identifier rubyid_agent'>agent</span><span class='comma'>,</span> <span class='const'>TermsOfMembership</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_new_tom_id'>new_tom_id</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_operation_types'>operation_types</span><span class='period'>.</span><span class='id identifier rubyid_save_the_sale'>save_the_sale</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_res'>res</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='lbrace'>{</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Member status does not allows us to save the sale.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_error_codes'>error_codes</span><span class='period'>.</span><span class='id identifier rubyid_member_status_dont_allow'>member_status_dont_allow</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="schedule_first_membership-instance_method">
  
    - (<tt>Object</tt>) <strong>schedule_first_membership</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Sends the fulfillment, and it settes bill_date and next_retry_bill_date
according to member&#8217;s terms of membership.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


153
154
155
156
157
158
159
160
161
162
163
164</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 153</span>

<span class='kw'>def</span> <span class='id identifier rubyid_schedule_first_membership'>schedule_first_membership</span>
  <span class='id identifier rubyid_send_fulfillment'>send_fulfillment</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_bill_date'>bill_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_provisional_days'>provisional_days</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_next_retry_bill_date'>next_retry_bill_date</span> <span class='op'>=</span> <span class='id identifier rubyid_bill_date'>bill_date</span>
  <span class='comment'># Documentation #18928 - recoveries will not change the quota number.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_reactivation_times'>reactivation_times</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_quota'>quota</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_monthly?'>monthly?</span> <span class='op'>?</span> <span class='int'>1</span> <span class='op'>:</span>  <span class='int'>0</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_join_date'>join_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_cancel_date'>cancel_date</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="schedule_first_membership_for_approved_member-instance_method">
  
    - (<tt>Object</tt>) <strong>schedule_first_membership_for_approved_member</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Sends the fulfillment, and it settes bill_date and next_retry_bill_date
according to member&#8217;s terms of membership.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


167
168
169
170
171
172
173
174
175
176</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 167</span>

<span class='kw'>def</span> <span class='id identifier rubyid_schedule_first_membership_for_approved_member'>schedule_first_membership_for_approved_member</span>
  <span class='id identifier rubyid_send_fulfillment'>send_fulfillment</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_bill_date'>bill_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_provisional_days'>provisional_days</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_next_retry_bill_date'>next_retry_bill_date</span> <span class='op'>=</span> <span class='id identifier rubyid_bill_date'>bill_date</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_reactivation_times'>reactivation_times</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_quota'>quota</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_terms_of_membership'>terms_of_membership</span><span class='period'>.</span><span class='id identifier rubyid_monthly?'>monthly?</span> <span class='op'>?</span> <span class='int'>1</span> <span class='op'>:</span>  <span class='int'>0</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_cancel_date'>cancel_date</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_active_email-instance_method">
  
    - (<tt>Object</tt>) <strong>send_active_email</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Sends the activation mail.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


137
138
139</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 137</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_active_email'>send_active_email</span>
  <span class='const'>Communication</span><span class='period'>.</span><span class='id identifier rubyid_deliver!'>deliver!</span><span class='lparen'>(</span><span class='symbol'>:active</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_fulfillment-instance_method">
  
    - (<tt>Object</tt>) <strong>send_fulfillment</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


442
443
444
445
446
447
448
449
450
451
452
453</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 442</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_fulfillment'>send_fulfillment</span>
  <span class='comment'># we always send fulfillment to new members or members that do not have 
</span>  <span class='comment'># opened fulfillments (meaning that previous fulfillments expired).
</span>  <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_fulfillments'>fulfillments</span><span class='period'>.</span><span class='id identifier rubyid_find_by_status'>find_by_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>open</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_fulfillments_products_to_send'>fulfillments_products_to_send</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_product'>product</span><span class='op'>|</span>
      <span class='id identifier rubyid_f'>f</span> <span class='op'>=</span> <span class='const'>Fulfillment</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='symbol'>:product</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_product'>product</span>
      <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_member_id'>member_id</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_uuid'>uuid</span>
      <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_assigned_at'>assigned_at</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
      <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_pre_bill-instance_method">
  
    - (<tt>Object</tt>) <strong>send_pre_bill</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


436
437
438
439
440</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 436</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_pre_bill'>send_pre_bill</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_can_bill_membership?'>can_bill_membership?</span>
    <span class='const'>Communication</span><span class='period'>.</span><span class='id identifier rubyid_deliver!'>deliver!</span><span class='lparen'>(</span><span class='symbol'>:prebill</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_join_date-instance_method">
  
    - (<tt>Object</tt>) <strong>set_join_date</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Sets join date. It is called when members status is changed from
&#8216;none&#8217; to &#8216;applied&#8217;
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


147
148
149
150</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 147</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_join_date'>set_join_date</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_join_date'>join_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="skip_api_sync!-instance_method">
  
    - (<tt>Object</tt>) <strong>skip_api_sync!</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


474
475
476</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 474</span>

<span class='kw'>def</span> <span class='id identifier rubyid_skip_api_sync!'>skip_api_sync!</span>
  <span class='ivar'>@skip_api_sync</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="synced?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>synced?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


478
479
480</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/member.rb', line 478</span>

<span class='kw'>def</span> <span class='id identifier rubyid_synced?'>synced?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_last_synced_at'>last_synced_at</span> <span class='op'>&amp;&amp;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_last_synced_at'>last_synced_at</span> <span class='op'>&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_updated_at'>updated_at</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Tue Jul 10 11:05:44 2012 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.2.1 (ruby-1.9.2).
</div>

  </body>
</html>